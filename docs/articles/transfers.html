<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transfer Tables • gtfsrouter</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Transfer Tables">
<meta property="og:description" content="gtfsrouter">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gtfsrouter</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0.010</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/UrbanAnalyst/gtfsrouter" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Transfer Tables</h1>
                        <h4 data-toc-skip class="author">Mark
Padgham</h4>
            
            <h4 data-toc-skip class="date">2023-06-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/UrbanAnalyst/gtfsrouter/blob/HEAD/vignettes/transfers.Rmd" class="external-link"><code>vignettes/transfers.Rmd</code></a></small>
      <div class="hidden name"><code>transfers.Rmd</code></div>

    </div>

    
    
<p>GTFS feeds may include a table of possible transfers between stops,
and potentially between specific connecting services. There feeds are
nevertheless optional, and many feeds omit transfer tables, making them
difficult if not impossible to use for routing. The
<code>gtfsrouter</code> package includes a function, <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link"><code>gtfs_transfer_table()</code></a>,
which calculates and inserts a transfer table into a feed.</p>
<div class="section level2">
<h2 id="basic-usage">Basic Usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<p>This function can also be demonstrated with the very small feed
included with this package, by first running <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/berlin_gtfs_to_zip.html" class="external-link"><code>berlin_gtfs_to_zip()</code></a>
to create the feed in the temporary directory of the current R
session.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span> <span class="op">(</span><span class="va"><a href="https://github.com/UrbanAnalyst/gtfsrouter" class="external-link">gtfsrouter</a></span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/berlin_gtfs_to_zip.html">berlin_gtfs_to_zip</a></span> <span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_gtfs.html">extract_gtfs</a></span> <span class="op">(</span><span class="va">f</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The transfers table of the feed looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span></span></code></pre></div>
<pre><code><span><span class="co">##       from_stop_id   to_stop_id transfer_type min_transfer_time from_route_id</span></span>
<span><span class="co">##    1: 000008010205 000008010205             2               300              </span></span>
<span><span class="co">##    2: 000008010205 000008098205             2               300              </span></span>
<span><span class="co">##    3: 000008010318 000008010318             2               300              </span></span>
<span><span class="co">##    4: 000008011460 000008011460             2               300              </span></span>
<span><span class="co">##    5: 000008012656 000008012656             2               300              </span></span>
<span><span class="co">##   ---                                                                        </span></span>
<span><span class="co">## 9829: 070101051881 070201024602             2               180              </span></span>
<span><span class="co">## 9830: 070101051881 070101051881             2               120              </span></span>
<span><span class="co">## 9831: 060230000099 060230000841             2               300              </span></span>
<span><span class="co">## 9832: 060230000099 060230000842             2               300              </span></span>
<span><span class="co">## 9833: 060230000099 060230000099             2               180              </span></span>
<span><span class="co">##       to_route_id from_trip_id to_trip_id</span></span>
<span><span class="co">##    1:                       NA         NA</span></span>
<span><span class="co">##    2:                       NA         NA</span></span>
<span><span class="co">##    3:                       NA         NA</span></span>
<span><span class="co">##    4:                       NA         NA</span></span>
<span><span class="co">##    5:                       NA         NA</span></span>
<span><span class="co">##   ---                                    </span></span>
<span><span class="co">## 9829:                       NA         NA</span></span>
<span><span class="co">## 9830:                       NA         NA</span></span>
<span><span class="co">## 9831:                       NA         NA</span></span>
<span><span class="co">## 9832:                       NA         NA</span></span>
<span><span class="co">## 9833:                       NA         NA</span></span></code></pre>
<p>A transfers table is required for successful routing between
different services, like with the following code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gtfs_route.html">gtfs_route</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>            from <span class="op">=</span> <span class="st">"Friedrichstr."</span>,</span>
<span>            to <span class="op">=</span> <span class="st">"Rosenthaler Platz"</span>,</span>
<span>            start_time <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">3600</span>,</span>
<span>            day <span class="op">=</span> <span class="st">"Monday"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   route_name       trip_name                      stop_name arrival_time</span></span>
<span><span class="co">## 1        S26 S Waidmannslust S+U Friedrichstr. Bhf (Berlin)     12:03:06</span></span>
<span><span class="co">## 2        S26 S Waidmannslust  S Oranienburger Str. (Berlin)     12:05:12</span></span>
<span><span class="co">## 3        S26 S Waidmannslust         S Nordbahnhof (Berlin)     12:07:12</span></span>
<span><span class="co">## 4        S26 S Waidmannslust        S Humboldthain (Berlin)     12:09:54</span></span>
<span><span class="co">## 5        S26 S Waidmannslust S+U Gesundbrunnen Bhf (Berlin)     12:11:42</span></span>
<span><span class="co">## 6         U8 S+U Hermannstr. S+U Gesundbrunnen Bhf (Berlin)     12:15:30</span></span>
<span><span class="co">## 7         U8 S+U Hermannstr.           U Voltastr. (Berlin)     12:17:00</span></span>
<span><span class="co">## 8         U8 S+U Hermannstr.       U Bernauer Str. (Berlin)     12:18:30</span></span>
<span><span class="co">## 9         U8 S+U Hermannstr.   U Rosenthaler Platz (Berlin)     12:20:00</span></span>
<span><span class="co">##   departure_time</span></span>
<span><span class="co">## 1       12:03:54</span></span>
<span><span class="co">## 2       12:05:42</span></span>
<span><span class="co">## 3       12:07:42</span></span>
<span><span class="co">## 4       12:10:24</span></span>
<span><span class="co">## 5       12:12:24</span></span>
<span><span class="co">## 6       12:15:30</span></span>
<span><span class="co">## 7       12:17:00</span></span>
<span><span class="co">## 8       12:18:30</span></span>
<span><span class="co">## 9       12:20:00</span></span></code></pre>
<p>That trip requires a transfer, and is possible because the feed has a
table specifying the possibility of transferring at the “S+U
Gesundbrunnen Bhf” station. Removing the transfers table demonstrates
what typically happens when attempting to calculate routes on feeds
which lack this information:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="../reference/gtfs_route.html">gtfs_route</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>            from <span class="op">=</span> <span class="st">"Friedrichstr."</span>,</span>
<span>            to <span class="op">=</span> <span class="st">"Rosenthaler Platz"</span>,</span>
<span>            start_time <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">3600</span>,</span>
<span>            day <span class="op">=</span> <span class="st">"Monday"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NULL</span></span></code></pre>
<p>No transfer is able to be make, and so no route is found. <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">The
<code>gtfs_transfer_table()</code> function</a> automatically calculates
and adds a transfer table to a feed, enabling it once again to be used
to generate routes:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span>, d_limit <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/gtfs_route.html">gtfs_route</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>            from <span class="op">=</span> <span class="st">"Friedrichstr."</span>,</span>
<span>            to <span class="op">=</span> <span class="st">"Rosenthaler Platz"</span>,</span>
<span>            start_time <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">3600</span>,</span>
<span>            day <span class="op">=</span> <span class="st">"Monday"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   route_name         trip_name                        stop_name arrival_time</span></span>
<span><span class="co">## 1         S7 S Ahrensfelde Bhf   S+U Friedrichstr. Bhf (Berlin)     12:00:36</span></span>
<span><span class="co">## 2         S7 S Ahrensfelde Bhf      S Hackescher Markt (Berlin)     12:02:54</span></span>
<span><span class="co">## 3         S7 S Ahrensfelde Bhf  S+U Alexanderplatz Bhf (Berlin)     12:04:36</span></span>
<span><span class="co">## 4         U8      S+U Wittenau S+U Alexanderplatz (Berlin) [U8]     12:07:30</span></span>
<span><span class="co">## 5         U8      S+U Wittenau       U Weinmeisterstr. (Berlin)     12:09:00</span></span>
<span><span class="co">## 6         U8      S+U Wittenau     U Rosenthaler Platz (Berlin)     12:10:30</span></span>
<span><span class="co">##   departure_time</span></span>
<span><span class="co">## 1       12:01:24</span></span>
<span><span class="co">## 2       12:03:24</span></span>
<span><span class="co">## 3       12:05:24</span></span>
<span><span class="co">## 4       12:07:30</span></span>
<span><span class="co">## 5       12:09:00</span></span>
<span><span class="co">## 6       12:10:30</span></span></code></pre>
<p>That route is considerably faster than the original one, because it
utilises a transfer (at “S+U Alexanderplatz”) which is not in the
original transfers table. That particular transfer highlights the most
important caveat to using <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">the
<code>gtfs_transfer_table()</code> function</a>: that tables may and
often will still require some degree of manual checking and adjustment
to make them usable, as demonstrated in the following section.</p>
</div>
<div class="section level2">
<h2 id="extending-transfer-tables">Extending transfer tables<a class="anchor" aria-label="anchor" href="#extending-transfer-tables"></a>
</h2>
<p>The above example first removed the transfer table by setting
<code>gtfs$transfers &lt;- NULL</code>. Applying <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">the
<code>gtfs_transfer_table()</code> function</a> to a feed which already
has a transfer table will extend that table by adding any additional
transfers within the specified distance (<a href="#transfer-distances">see below</a>). Any transfers already present
in the transfers table will be retained as is, and the table will be
extended by adding any new transfers not present in the original
table.</p>
<p>Transfers are calculated based on distance alone, and do not utilise
any information on routes or trips. Some feeds, such as the <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/berlin_gtfs_to_zip.html" class="external-link">example
Berlin feed included with this package</a>, include transfer information
between specific routes and services, resulting in a transfers table in
which station pairs are repeated numerous times for distinct
combinations of routes and services:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_gtfs.html">extract_gtfs</a></span> <span class="op">(</span><span class="va">f</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># 'f' is the location generated above</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 9833</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span> <span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span> <span class="op">(</span><span class="st">"from_stop_id"</span>, <span class="st">"to_stop_id"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2229</span></span></code></pre>
<p>The table only has 2,229 unique pairs of <code>from</code> and
<code>to</code> stops, yet details 9,833 possibles ways of transferring
between these stops. Removing and re-generating these transfers gives
the following results:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1894</span></span></code></pre>
<p>The <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link"><code>gtfs_transfer_table()</code>
function</a> generates -335 additional transfers not present in the
original feed, but as stated contains no information on transfers
between specific routes or trips. Alternatively, using the function to
extend the existing table, rather than re-generate it, gives the
following result:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_gtfs.html">extract_gtfs</a></span> <span class="op">(</span><span class="va">f</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10369</span></span></code></pre>
<p>Note that each call to <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link"><code>gtfs_transfer_table()</code></a>
will only extend the table through adding any transfers not present in
the previous table, and that no transfers will be removed. The following
code uses the <code>d_limit</code> parameter <a href="#transfer-distances">described below</a> to calculate transfer
tables for increasing maximal transfer distances.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_gtfs.html">extract_gtfs</a></span> <span class="op">(</span><span class="va">f</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">10</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span>, d_limit <span class="op">=</span> <span class="va">i</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span>            <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">)</span><span class="op">)</span></span>
<span>           <span class="op">}</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span> <span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  9834 10291 10369 10477 10665 10923 11677 12645 13729 14971 16149</span></span></code></pre>
<p>The transfer table increases in size with each call, and retains all
transfers generated from all previous calls. Because each call involves
extending the transfer table, the table at each stage may be used for
routing with transfers out to each specified distance. Subsequently
reducing the transfer distance would then not be appropriate, as the
table would still retain all transfers at previously-calculated (longer)
distances:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span>, d_limit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10291</span></span></code></pre>
<p>In this case, the table would first have to be removed
(<code>gtfs$transfers &lt;- NULL</code>), and the recalculated at the
specified distance.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span>, d_limit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1816</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="modifying-transfer-tables">Modifying transfer tables<a class="anchor" aria-label="anchor" href="#modifying-transfer-tables"></a>
</h2>
<p>This section demonstrates that transfer tables generated using <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">the
<code>gtfs_transfer_table()</code> function</a> often need to be
manually modified to ensure sensible results. The second route generated
above after using <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">the
<code>gtfs_transfer_table()</code> function</a> includes a transfer at
“S+U Alexanderplatz” from a route named “S7” to one named “U8”. This
train station is in fact one of the largest stations in Berlin, with the
“S” routes using elevated platforms above ground, and the “U” denoting
underground. The “U8” in particular is quite a long way underground, and
while transfer in the indicated time of just under three minutes may be
theoretically possible, it would likely require running, and ought not
be generally presumed to reflect a viable transfer.</p>
<p>Note further that the actual locations of these stations can be
extracted with the following lines:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_route.html">gtfs_route</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>                 from <span class="op">=</span> <span class="st">"Friedrichstr."</span>,</span>
<span>                 to <span class="op">=</span> <span class="st">"Rosenthaler Platz"</span>,</span>
<span>                 start_time <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">3600</span>,</span>
<span>                 day <span class="op">=</span> <span class="st">"Monday"</span>,</span>
<span>                 include_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">stns</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="va">stop_id</span> <span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="co"># the transfer station IDs</span></span>
<span><span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span> <span class="op">(</span><span class="va">stns</span>, <span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span><span class="op">$</span><span class="va">stop_id</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##         stop_id stop_code                        stop_name stop_desc stop_lat</span></span>
<span><span class="co">## 1: 060100003723            S+U Alexanderplatz Bhf (Berlin)           52.52151</span></span>
<span><span class="co">## 2: 070201083602           S+U Alexanderplatz (Berlin) [U8]           52.52162</span></span>
<span><span class="co">##    stop_lon location_type parent_station wheelchair_boarding</span></span>
<span><span class="co">## 1: 13.41127             0   900000100003                  NA</span></span>
<span><span class="co">## 2: 13.41212             0   900000100705                  NA</span></span></code></pre>
<p>The distance between them is:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span> <span class="op">(</span><span class="va">stns</span>, <span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span><span class="op">$</span><span class="va">stop_id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span> <span class="op">(</span><span class="fu">geodist</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geodist/man/geodist.html" class="external-link">geodist</a></span> <span class="op">(</span><span class="va">s</span> <span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">s</span> <span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 59.22425</span></span></code></pre>
<p>The transfer table algorithm presumes a pedestrian speed of 4km /
hour, which is 1.11 m/s, meaning this distance should be able to be
covered in just over 50 seconds. In reality, it would be impossible to
run between these two stops in 50 seconds, primarily because of a need
to traverse 3 or 4 vertical levels.</p>
<p>We now demonstrate how to add more realistic transfer times, by
adding additional time penalties for transferring between underground
and overground services, to reflect the extra time required to travel up
or down between stops. The sample feed included with this package only
has “U” and “S” routes. The following code demonstrates how to use this
distinction to add additional time penalties to the transfers table. The
first step is to find the <code>trip_id</code> values of all “S” and “U”
services, which is itself a two-step procedure to first extract
<code>route_id</code> values and then match these to
<code>trip_id</code> values. Procedures may vary between feeds, but in
the case of Berlin, the routes are all identified by their
<code>route_short_name</code>, as follows:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S_routes</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span> <span class="op">(</span><span class="st">"^S"</span>, <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_short_name</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">U_routes</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span> <span class="op">(</span><span class="st">"^U"</span>, <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_short_name</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">S_trips</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">trip_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">route_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_routes</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">U_trips</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">trip_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">route_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_routes</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The following code then uses those <code>trip_id</code> values to
extract all corresponding stops.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S_stops</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">stop_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">trip_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_trips</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">S_stops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span> <span class="op">(</span><span class="va">S_stops</span><span class="op">)</span></span>
<span><span class="va">U_stops</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">stop_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">trip_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_trips</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">U_stops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span> <span class="op">(</span><span class="va">U_stops</span><span class="op">)</span></span></code></pre></div>
<p>Although in Berlin the stops for “U” and “S” services are strictly
separated, this may not be the case for all other feeds. It might, for
example, be useful to remove stops which are used by both types of
services, leaving stops that can only serve as transfers between
different kinds of services. The following two lines suffice for
that:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S_stops</span> <span class="op">&lt;-</span> <span class="va">S_stops</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="va">S_stops</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_stops</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">U_stops</span> <span class="op">&lt;-</span> <span class="va">U_stops</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="va">U_stops</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_stops</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>All we then need to do is to add additional transfers times for any
transfers between these two sets of stops, arbitrarily choosing here a
value of 2 minutes:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">from_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_stops</span> <span class="op">&amp;</span></span>
<span>                 <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">to_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_stops</span><span class="op">)</span> <span class="op">|</span></span>
<span>                <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">from_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_stops</span> <span class="op">&amp;</span></span>
<span>                 <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">to_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_stops</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">min_transfer_time</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">min_transfer_time</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span>  <span class="op">+</span> <span class="fl">120</span></span></code></pre></div>
<p>Our route query then returns the following:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gtfs_route.html">gtfs_route</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>            from <span class="op">=</span> <span class="st">"Friedrichstr."</span>,</span>
<span>            to <span class="op">=</span> <span class="st">"Rosenthaler Platz"</span>,</span>
<span>            start_time <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">3600</span>,</span>
<span>            day <span class="op">=</span> <span class="st">"Monday"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   route_name         trip_name                        stop_name arrival_time</span></span>
<span><span class="co">## 1         S5 S Strausberg Nord   S+U Friedrichstr. Bhf (Berlin)     12:03:06</span></span>
<span><span class="co">## 2         S5 S Strausberg Nord      S Hackescher Markt (Berlin)     12:05:24</span></span>
<span><span class="co">## 3         S5 S Strausberg Nord  S+U Alexanderplatz Bhf (Berlin)     12:07:06</span></span>
<span><span class="co">## 4         U8  U Paracelsus-Bad S+U Alexanderplatz (Berlin) [U8]     12:12:30</span></span>
<span><span class="co">## 5         U8  U Paracelsus-Bad       U Weinmeisterstr. (Berlin)     12:14:00</span></span>
<span><span class="co">## 6         U8  U Paracelsus-Bad     U Rosenthaler Platz (Berlin)     12:15:30</span></span>
<span><span class="co">##   departure_time</span></span>
<span><span class="co">## 1       12:03:54</span></span>
<span><span class="co">## 2       12:05:54</span></span>
<span><span class="co">## 3       12:07:54</span></span>
<span><span class="co">## 4       12:12:30</span></span>
<span><span class="co">## 5       12:14:00</span></span>
<span><span class="co">## 6       12:15:30</span></span></code></pre>
<p>The route follows exactly the same connections, but now allows a far
more realistic time of just over 5 minutes for the transfer at
Alexanderplatz. This exemplifies that, while <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">the
<code>gtfs_transfer_table()</code> function</a> can “automatically”
generate transfer tables, these will often still need manual tweaking
and adjustment to reflect the unique characteristics of any given
system.</p>
</div>
<div class="section level2">
<h2 id="transfer-distances">Transfer distances<a class="anchor" aria-label="anchor" href="#transfer-distances"></a>
</h2>
<p><a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">The
<code>gtfs_transfer_table()</code> function</a> includes an additional
parameter, <code>d_limit</code>, quantifying the maximum permissible
walking distance between transfers, with a default value of 200 metres.
Increasing this value generates greater numbers of possible transfers,
as the following code illustrates, starting by removing and re-creating
the transfer table, followed by adding the additional penalties for
transfers between the two types of services, this time constructed as a
function for easy re-use:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span>, d_limit <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="va">transfer_penalties</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">gtfs</span>, <span class="va">penalty</span> <span class="op">=</span> <span class="fl">120</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">S_routes</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span> <span class="op">(</span><span class="st">"^S"</span>, <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_short_name</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">U_routes</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span> <span class="op">(</span><span class="st">"^U"</span>, <span class="va">gtfs</span><span class="op">$</span><span class="va">routes</span><span class="op">$</span><span class="va">route_short_name</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">S_trips</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">trip_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">route_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_routes</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">U_trips</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">trip_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">trips</span><span class="op">$</span><span class="va">route_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_routes</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">S_stops</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">stop_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">trip_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_trips</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">S_stops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span> <span class="op">(</span><span class="va">S_stops</span><span class="op">)</span></span>
<span>    <span class="va">U_stops</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">stop_id</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">stop_times</span><span class="op">$</span><span class="va">trip_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_trips</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">U_stops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span> <span class="op">(</span><span class="va">U_stops</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">S_stops</span> <span class="op">&lt;-</span> <span class="va">S_stops</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="va">S_stops</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_stops</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">U_stops</span> <span class="op">&lt;-</span> <span class="va">U_stops</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="va">U_stops</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_stops</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">from_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_stops</span> <span class="op">&amp;</span></span>
<span>                     <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">to_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_stops</span><span class="op">)</span> <span class="op">|</span></span>
<span>                    <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">from_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">U_stops</span> <span class="op">&amp;</span></span>
<span>                     <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">to_stop_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">S_stops</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">min_transfer_time</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>        <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">$</span><span class="va">min_transfer_time</span> <span class="op">[</span><span class="va">index</span><span class="op">]</span>  <span class="op">+</span> <span class="fl">120</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu">transfer_penalties</span> <span class="op">(</span><span class="va">gtfs</span><span class="op">)</span></span></code></pre></div>
<p>Submitting the same routing query now gives the following:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gtfs_route.html">gtfs_route</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>            from <span class="op">=</span> <span class="st">"Friedrichstr."</span>,</span>
<span>            to <span class="op">=</span> <span class="st">"Rosenthaler Platz"</span>,</span>
<span>            start_time <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">3600</span>,</span>
<span>            day <span class="op">=</span> <span class="st">"Monday"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   route_name         trip_name                        stop_name arrival_time</span></span>
<span><span class="co">## 1         S5 S Strausberg Nord   S+U Friedrichstr. Bhf (Berlin)     12:03:06</span></span>
<span><span class="co">## 2         S5 S Strausberg Nord      S Hackescher Markt (Berlin)     12:05:24</span></span>
<span><span class="co">## 3         S5 S Strausberg Nord  S+U Alexanderplatz Bhf (Berlin)     12:07:06</span></span>
<span><span class="co">## 4         U8  U Paracelsus-Bad S+U Alexanderplatz (Berlin) [U8]     12:12:30</span></span>
<span><span class="co">## 5         U8  U Paracelsus-Bad       U Weinmeisterstr. (Berlin)     12:14:00</span></span>
<span><span class="co">## 6         U8  U Paracelsus-Bad     U Rosenthaler Platz (Berlin)     12:15:30</span></span>
<span><span class="co">##   departure_time</span></span>
<span><span class="co">## 1       12:03:54</span></span>
<span><span class="co">## 2       12:05:54</span></span>
<span><span class="co">## 3       12:07:54</span></span>
<span><span class="co">## 4       12:12:30</span></span>
<span><span class="co">## 5       12:14:00</span></span>
<span><span class="co">## 6       12:15:30</span></span></code></pre>
<p>The route departs and arrives at the same time, but now includes an
additional walking transfer over a distance which can be calculated by
repeating the lines above:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_route.html">gtfs_route</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>                 from <span class="op">=</span> <span class="st">"Friedrichstr."</span>,</span>
<span>                 to <span class="op">=</span> <span class="st">"Rosenthaler Platz"</span>,</span>
<span>                 start_time <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">3600</span>,</span>
<span>                 day <span class="op">=</span> <span class="st">"Monday"</span>,</span>
<span>                 include_ids <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span> <span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">stop_id</span> <span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, <span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span><span class="op">$</span><span class="va">stop_id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span> <span class="op">(</span><span class="fu">geodist</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geodist/man/geodist.html" class="external-link">geodist</a></span> <span class="op">(</span><span class="va">s</span> <span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">s</span> <span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 614.5902</span></span></code></pre>
<p>At a speed of 1.11m/s, this would take just under 6 minutes. With the
additional penalty of 2 minutes for transferring from an “S” to a “U”
service, this transfer would require just under 8 minutes, which is less
than the time given in the route of just over 8.5 minutes. This
demonstrates how increasing maximal walking distances increases numbers
of possible transfers.</p>
<p>The following code shows the sizes of transfer tables as a function
of maximal walking distances:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d_limit</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span> <span class="op">(</span><span class="va">d_limit</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>                 <span class="va">gtfs</span><span class="op">$</span><span class="va">transfer</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>                 <span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span>, d_limit <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span><span class="op">)</span></span>
<span>                 <span class="op">}</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span> <span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d_limit</span> <span class="op">&lt;-</span> <span class="va">d_limit</span> <span class="op">/</span> <span class="fl">1000</span> <span class="co"># in km</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">/</span> <span class="fl">1000</span> <span class="co"># in thousands</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span> <span class="op">(</span><span class="va">d_limit</span>, <span class="va">n</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      xlab <span class="op">=</span> <span class="st">"Maximal transfer distance"</span>,</span>
<span>      ylab <span class="op">=</span> <span class="st">"Number of transfers (1000s)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="transfers_files/figure-html/d_limit1-1.png" width="700"></p>
<p>The line is initially flat because this number (around 3,300) is the
number of transfers possible between stops which have identical spatial
locations (and so a distance of 0.0). Numbers of transfers can never be
less than this number.</p>
<p>The following section delves further into the effect of this distance
limit, though examining the result of <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_traveltimes.html" class="external-link"><code>gtfs_traveltimes()</code></a>
for different distance limits.</p>
</div>
<div class="section level2">
<h2 id="transfer-distances-and-travel-times">Transfer distances and travel times<a class="anchor" aria-label="anchor" href="#transfer-distances-and-travel-times"></a>
</h2>
<p>The preceding result might be sensibly interpreted to reflect
something like a plausible upper limit for a transfer, with a distance
of 370 metres, plus a vertical transfer between underground and
overground services, expected to be covered in under 8.5 minutes. This
might – and indeed likely should – in turn be considered to demonstrate
how this <code>d_limit</code> parameter, along with any additional
manual adjustments applied to transfer tables, like the
<code>transfer_penalties()</code> function constructed above, need to be
carefully considered with regard to concrete knowledge of a particular
system.</p>
<p>The <code>gtfsrouter</code> package is nevertheless not intended to
be used only to generate individual routing queries, but also includes
<a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_traveltimes.html" class="external-link">the
<code>gtfs_traveltimes()</code> function</a> designed to enable
efficient estimation of travel times anywhere in a system from any
nominated station. The result of this function will obviously be
influenced by the transfers table, and in particular by the maximal
walking distance used to construct transfer tables with <a href="https://UrbanAnalyst.github.io/gtfsrouter/reference/gtfs_transfer_table.html" class="external-link">the
<code>gtfs_transfer_table()</code> function</a>.</p>
<p>The effect of different distances can also be examined using the
internal data set provided with this package. The following function
generates travel times for a given <code>d_limit</code> a random sample
of starting stations:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span> <span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">travel_times_d_limit</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">gtfs</span>, <span class="va">from</span>, <span class="va">d_limit</span> <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">gtfs</span><span class="op">$</span><span class="va">transfers</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">gtfs</span>, d_limit <span class="op">=</span> <span class="va">d_limit</span><span class="op">)</span></span>
<span>    <span class="va">gtfs</span> <span class="op">&lt;-</span> <span class="fu">transfer_penalties</span> <span class="op">(</span><span class="va">gtfs</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">start_time_limits</span> <span class="op">&lt;-</span> <span class="fl">12</span><span class="op">:</span><span class="fl">13</span> <span class="op">*</span> <span class="fl">3600</span></span>
<span></span>
<span>    <span class="va">get_one_times</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">gtfs</span>, <span class="va">from</span>, <span class="va">start_time_limits</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_traveltimes.html">gtfs_traveltimes</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>                               from <span class="op">=</span> <span class="va">from</span>,</span>
<span>                               start_time_limits <span class="op">=</span> <span class="va">start_time_limits</span>,</span>
<span>                               quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">ret</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>            <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span> <span class="op">(</span>from <span class="op">=</span> <span class="va">from</span>,</span>
<span>                               to <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">stop_id</span>,</span>
<span>                               duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span></span>
<span>        <span class="co"># duration in minutes</span></span>
<span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">ret</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span> <span class="op">(</span><span class="va">from</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>                   <span class="fu">get_one_times</span> <span class="op">(</span><span class="va">gtfs</span>, <span class="va">i</span>, <span class="va">start_time_limits</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span> <span class="op">(</span><span class="va">rbind</span>, <span class="va">res</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span> <span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span> <span class="op">(</span>duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span> <span class="op">(</span><span class="va">duration</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span>    <span class="va">res</span><span class="op">$</span><span class="va">d_limit</span> <span class="op">&lt;-</span> <span class="va">d_limit</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function returns travel times from all stations listed in
<code>from</code> to all other (reachable) stations for the specified
value of <code>d_limit</code>. The following lines then compare these
travel times between identical origin and destination stations for a
range of distance limits.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">from</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span><span class="op">$</span><span class="va">stop_name</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">d_limit</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span> <span class="op">(</span><span class="va">d_limit</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>             <span class="fu">travel_times_d_limit</span> <span class="op">(</span><span class="va">gtfs</span>, from <span class="op">=</span> <span class="va">from</span>, d_limit <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">xall</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span> <span class="op">(</span><span class="va">rbind</span>, <span class="va">x</span><span class="op">)</span> <span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span> <span class="op">(</span><span class="st">"from"</span>, <span class="st">"to"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">xall</span> <span class="op">&lt;-</span> <span class="va">xall</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span> <span class="op">(</span><span class="va">xall</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span> <span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span> <span class="op">(</span><span class="va">xall</span>, <span class="va">x</span> <span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span> <span class="op">(</span><span class="st">"from"</span>, <span class="st">"to"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">xall</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span> <span class="op">(</span><span class="st">"d_"</span>, <span class="va">x</span> <span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">d_limit</span> <span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">$</span><span class="va">duration</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">xall</span><span class="op">$</span><span class="va">d_1000</span> <span class="op">!=</span> <span class="va">xall</span><span class="op">$</span><span class="va">d_100</span><span class="op">)</span></span>
<span><span class="co"># record number of stations for which travel times did not change:</span></span>
<span><span class="va">nsame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">xall</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xall</span> <span class="op">&lt;-</span> <span class="va">xall</span> <span class="op">[</span><span class="va">index</span>, <span class="op">]</span></span>
<span><span class="co"># travel times only:</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="va">xall</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span> <span class="op">(</span><span class="st">"from"</span>, <span class="st">"to"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># differences with each increase in d_limit:</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span> <span class="op">(</span><span class="va">times</span>, <span class="fl">1</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span> <span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span> <span class="op">(</span>t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span> <span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span> <span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span> <span class="op">(</span><span class="va">times</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">stat_bin</a></span> <span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span>, col <span class="op">=</span> <span class="st">"red"</span>, fill <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span> <span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span> <span class="op">(</span><span class="st">"time difference (minutes)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="transfers_files/figure-html/plot1-1.png" width="700"></p>
<p>And these additional transfer possibilities can make a significant
difference to estimated travel times. Note, however, that the travel
times only changed for 305 stations, while the value of
<code>nsame</code> value recording numbers of stations for which travel
times did not change was 4,350. Travel times may also increase as
additional transfers may be used to reduce numbers of connecting
services required for a particular trip, and the algorithm generally
searches for connections with minimal numbers of transfers.</p>
<p>The following code the quantifies the overall effect of these
reductions in travel times, measured as the linear reduction in
comparison with travel times calculated using the original transfers
table provided with the feed. The function also returns the proportion
of all stations for which travel times were affected by the modified
transfer table.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transfer_difference</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>                                 <span class="va">nsamples</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                 <span class="va">d_limit</span> <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                                 <span class="va">day</span> <span class="op">=</span> <span class="st">"Monday"</span>,</span>
<span>                                 <span class="va">start_time_limits</span> <span class="op">=</span> <span class="fl">12</span><span class="op">:</span><span class="fl">13</span> <span class="op">*</span> <span class="fl">3600</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">)</span></span>
<span>    <span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_timetable.html">gtfs_timetable</a></span> <span class="op">(</span><span class="va">g1</span>, day <span class="op">=</span> <span class="va">day</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">)</span></span>
<span>    <span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_transfer_table.html">gtfs_transfer_table</a></span> <span class="op">(</span><span class="va">g2</span>, d_limit <span class="op">=</span> <span class="va">d_limit</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_timetable.html">gtfs_timetable</a></span> <span class="op">(</span><span class="va">g2</span>, day <span class="op">=</span> <span class="va">day</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">get1</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">gtfs</span>, <span class="va">gtfs2</span>, <span class="va">start_time_limits</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="va">from</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span> <span class="op">(</span><span class="va">gtfs</span><span class="op">$</span><span class="va">stops</span><span class="op">$</span><span class="va">stop_name</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>        <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_traveltimes.html">gtfs_traveltimes</a></span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>                                from <span class="op">=</span> <span class="va">from</span>,</span>
<span>                                start_time_limits <span class="op">=</span> <span class="va">start_time_limits</span>,</span>
<span>                                quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gtfs_traveltimes.html">gtfs_traveltimes</a></span> <span class="op">(</span><span class="va">gtfs2</span>,</span>
<span>                                from <span class="op">=</span> <span class="va">from</span>,</span>
<span>                                start_time_limits <span class="op">=</span> <span class="va">start_time_limits</span>,</span>
<span>                                quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0L</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">x2</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span></span>
<span>            <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span> <span class="op">(</span><span class="cn">NA</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span> <span class="op">(</span>stop_id <span class="op">=</span> <span class="va">x2</span><span class="op">$</span><span class="va">stop_id</span>,</span>
<span>                          duration2 <span class="op">=</span> <span class="va">x2</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span></span>
<span>        <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span> <span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, by <span class="op">=</span> <span class="st">"stop_id"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span> <span class="op">(</span><span class="va">x2</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span> <span class="op">/</span> <span class="fl">60</span>,</span>
<span>                           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span> <span class="op">(</span><span class="va">x2</span><span class="op">$</span><span class="va">duration2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span></span>
<span>        <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span> <span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span> <span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span> <span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">x</span> <span class="op">!=</span> <span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span> <span class="op">(</span><span class="va">dat</span><span class="op">)</span>,</span>
<span>                   change <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span> <span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span> <span class="op">(</span><span class="va">nsamples</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>            <span class="fu">get1</span> <span class="op">(</span><span class="va">g1</span>, <span class="va">g2</span>, <span class="va">start_time_limits</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span> <span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>            USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>That function can then be used to loop over a range of values of
<code>d_limit</code>, and to examine the results with the following
code:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d_limit</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span> <span class="op">(</span><span class="va">d_limit</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>             <span class="fu">transfer_difference</span> <span class="op">(</span><span class="va">gtfs</span>,</span>
<span>                                  nsamples <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                  d_limit <span class="op">=</span> <span class="va">i</span>,</span>
<span>                                  day <span class="op">=</span> <span class="st">"Monday"</span>,</span>
<span>                                  start_time_limits <span class="op">=</span> <span class="fl">12</span><span class="op">:</span><span class="fl">13</span> <span class="op">*</span> <span class="fl">3600</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span> <span class="op">(</span><span class="va">d_limit</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span> <span class="op">(</span>d_limit <span class="op">=</span> <span class="va">d_limit</span> <span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                         prop <span class="op">=</span> <span class="va">d</span> <span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>,</span>
<span>                         change <span class="op">=</span> <span class="va">d</span> <span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span> <span class="op">(</span><span class="va">rbind</span>, <span class="va">d</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span> <span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="va">d_limit</span>, y <span class="op">=</span> <span class="va">change</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span> <span class="op">(</span>pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span> <span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span><span class="op">)</span></span></code></pre></div>
<p><img src="transfers_files/figure-html/transfer_d_limit_results-1.png" width="700"></p>
<p>That result shows that travel times do decrease with increasing
limits of maximal transfer distance, although the overall effect is very
minimal. The object <code>d</code> also records the proportion of
station pairs for which modifications to the transfers table actually
changed travel times, which in this case amounts to a mean value of
0.001, clearly revealing that very few trips actually change.</p>
<div class="section level3">
<h3 id="a-more-realistic-example">A more realistic example<a class="anchor" aria-label="anchor" href="#a-more-realistic-example"></a>
</h3>
<p>The following results apply the code given above to the full feed for
Stuttgart, Germany, showing what might more typically be expected as the
<code>d_limit</code> parameter is increased.</p>
<p><img src="transfers_files/figure-html/stuttgart-results-1.png" width="700"></p>
<p>The decrease in travel times in this case approaches 15% as transfers
are implemented with walks of up to 1km, although values are highly
variable depending on starting stations. The equivalent proportion of
stops for which these transfers actually change travel times is shown in
the following graph:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span> <span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span> <span class="op">(</span>x <span class="op">=</span> <span class="va">d_limit</span>, y <span class="op">=</span> <span class="va">prop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span> <span class="op">(</span>pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span> <span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, formula <span class="op">=</span> <span class="st">"y ~ x"</span><span class="op">)</span></span></code></pre></div>
<p><img src="transfers_files/figure-html/stuttgart-plot2-1.png" width="700"></p>
<p>While travel times to most stops still remain unaffected, the
proportion affected does increase to a large minority of around 30-40%
as transfer distances approach 1km.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Padgham, Marcin Stepniak.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
